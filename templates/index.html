<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morse SNS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
        /* â–¼â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ  â–¼â–¼â–¼ */
        
        /* 1. åŸºæœ¬ã®è‰²å¤‰æ•°ã‚’ä¸Šæ›¸ã */
        :root {
            --bs-primary: #ff0055; /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ */
            --bs-primary-rgb: 255, 0, 85; /* é€æ˜åº¦è¨ˆç®—ç”¨(R, G, B) */
        }

        /* 2. å¡—ã‚Šã¤ã¶ã—ãƒœã‚¿ãƒ³ (.btn-primary) ã®ä¸Šæ›¸ã */
        .btn-primary {
            background-color: #ff0055;
            border-color: #ff0055;
        }
        /* ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸæ™‚ï¼ˆãƒ›ãƒãƒ¼ï¼‰ã¯å°‘ã—æš—ãã™ã‚‹ */
        .btn-primary:hover, .btn-primary:focus, .btn-primary:active {
            background-color: #cc0044 !important;
            border-color: #cc0044 !important;
        }

        /* 3. æ ç·šãƒœã‚¿ãƒ³ (.btn-outline-primary) ã®ä¸Šæ›¸ã */
        /* â€»ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€Œã‚ãªãŸã€ãƒãƒƒã‚¸ãªã©ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ */
        .btn-outline-primary {
            color: #ff0055;
            border-color: #ff0055;
        }
        .btn-outline-primary:hover {
            background-color: #ff0055;
            border-color: #ff0055;
        }

        /* 4. ãã®ä»–ã®éƒ¨å“ï¼ˆæ ç·šã€æ–‡å­—è‰²ã€ãƒãƒƒã‚¸èƒŒæ™¯ï¼‰ã®ä¸Šæ›¸ã */
        .border-primary { border-color: #ff0055 !important; }
        .text-primary { color: #ff0055 !important; }
        .bg-primary { background-color: #ff0055 !important; }

        /* â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–² */

</style>

    <script>
        // è¿”ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚
        function addReply(postId) {
            const textarea = document.getElementById('messageInput');
            textarea.value += ">>" + postId + " ";
            textarea.focus();
            // è¿”ä¿¡ã‚’è¿½åŠ ã—ãŸç¬é–“ã‚‚æ–‡å­—ãƒã‚§ãƒƒã‚¯ã‚’èµ°ã‚‰ã›ã‚‹ï¼ˆå¿µã®ãŸã‚ï¼‰
            textarea.dispatchEvent(new Event('input')); 
        }

        // è§£èª­ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚
        function toggleDecryption(postId) {
            const morseElem = document.getElementById('post-morse-' + postId);
            const originElem = document.getElementById('post-origin-' + postId);

            if (morseElem && originElem) {
                // d-noneï¼ˆéè¡¨ç¤ºã‚¯ãƒ©ã‚¹ï¼‰ã‚’ä»˜ã‘å¤–ã—ã—ã¦åˆ‡ã‚Šæ›¿ãˆã‚‹
                morseElem.classList.toggle('d-none');
                originElem.classList.toggle('d-none');
            }
        }
        function sendLike(postId) {
            // 1. ã‚µãƒ¼ãƒãƒ¼ã«ã€Œã„ã„ã­ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ (ãƒªãƒ­ãƒ¼ãƒ‰ãªã—)
            fetch('/like/' + postId, {
                method: 'POST'
            })
            .then(response => response.json()) // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”äº‹(JSON)ã‚’å—ã‘å–ã‚‹
            .then(data => {
                // 2. ç”»é¢ä¸Šã®æ•°å­—ã‚’æ›¸ãæ›ãˆã‚‹
                // id="like-count-æ•°å­—" ã®å ´æ‰€ã‚’æ¢ã—ã¦ã€æ–°ã—ã„æ•°å­—ã‚’å…¥ã‚Œã‚‹
                const countSpan = document.getElementById('like-count-' + postId);
                if (countSpan) {
                    countSpan.textContent = "â™¥ " + data.likes;
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</head>
<body class="bg-light">

{% if is_admin %}
<div class="alert alert-danger text-center m-0 p-1 rounded-0">
    ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­ 
    <a href="/admin/logout" class="btn btn-sm btn-outline-danger ms-3 bg-white">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
</div>
{% endif %}

<div class="container mt-5" style="max-width: 600px;">
    <h1 class="text-center mb-4">ã‚ªãƒ›å£°ãƒ¢ãƒ¼ãƒ«ã‚¹æ²ç¤ºæ¿</h1>
    <a href="/about" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 mt-2">
            ? ä½¿ã„æ–¹
        </a>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form action="/" method="POST">
                <div class="mb-3">
                    <label class="form-label">ãŠåå‰</label>
                    <input type="text" name="name" class="form-control" placeholder="åç„¡ã—ã•ã‚“" value="{{ saved_name }}">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ <small class="text-muted">ï¼ˆã‹ãªãƒ»æ•°å­—ãƒ»è¨˜å·ã®ã¿ï¼‰</small></label>
                    <textarea name="content" id="messageInput" class="form-control" rows="3" 
                              placeholder="ã„ã¾ãƒŠãƒ‹ã—ã¦ã‚‹ï¼Ÿ" required></textarea>
                    <div id="inputHelp" class="form-text text-danger fw-bold" style="height: 1.5em;"></div>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">æŠ•ç¨¿ã™ã‚‹ï¼ˆãƒ¢ãƒ¼ãƒ«ã‚¹å¤‰æ›ï¼‰</button>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-end mb-3">
        <div class="btn-group">
            <a href="/?sort=new" class="btn btn-outline-secondary btn-sm">æ–°ç€é †</a>
            <a href="/?sort=likes" class="btn btn-outline-secondary btn-sm">äººæ°—é †</a>
        </div>
    </div>

    {% if fixed_post or is_admin %}
    <div class="card mb-4 border-warning border-3 shadow-sm">
        <div class="card-header bg-warning-subtle d-flex justify-content-between align-items-center">
            <strong>ğŸ“Œ ãŠçŸ¥ã‚‰ã›ãƒ»ä½¿ã„æ–¹</strong>
            
            {% if is_admin %}
            <a href="/admin/edit_fixed" class="btn btn-sm btn-dark">
                âœï¸ å†…å®¹ã‚’ç·¨é›†
            </a>
            {% endif %}
        </div>
        
        <div class="card-body">
            {% if fixed_post %}
                <div class="card-text">{{ fixed_post[2] | safe | linkify_reply }}</div>
                <div class="text-end text-muted small mt-2">
                    {{ fixed_post[4] }}
                </div>
            {% else %}
                <p class="text-muted mb-0">ï¼ˆã¾ã å›ºå®šæŠ•ç¨¿ã®è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œç·¨é›†ã€ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ï¼‰</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="list-group">
        {% for post in posts %}
        <div id="post-{{ post[0] }}" class="list-group-item mb-3 shadow-sm rounded
            {% if current_user_id == post[3] %} border border-2 border-primary bg-white {% endif %}">
            
            <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center">
                    <div>
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0 fw-bold">{{ post[1] }}</h6>
                            {% if current_user_id == post[3] %}
                            <span class="badge bg-primary ms-2" style="font-size: 0.7em;">ã‚ãªãŸ</span>
                            {% endif %}
                        </div>
                        <small class="text-muted" style="font-size: 0.8em;">ID: {{ post[0] }} â€¢ {{ post[4] }}</small>
                    </div>
                </div>
            </div>
            
            <div class="ms-0 mb-3">
                <p id="post-morse-{{ post[0] }}" class="mb-0 morse-text fs-5">
                    {{ post[6] | linkify_reply }}
                </p>

                <p id="post-origin-{{ post[0] }}" class="mb-0 d-none text-dark fs-5">
                    {{ post[2] | linkify_reply }}
                </p>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
                
                <button type="button" class="btn btn-sm btn-outline-dark" onclick="toggleDecryption({{ post[0] }})">
                    ğŸ’¡ è§£èª­/éš ã™
                </button>

                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-link text-decoration-none text-muted me-2" 
                            onclick="addReply({{ post[0] }})">
                        â†© è¿”ä¿¡
                    </button>

                    <button type="button" class="btn btn-sm btn-outline-danger border-0 me-2" 
                            onclick="sendLike({{ post[0] }})">
                         <span id="like-count-{{ post[0] }}">â™¥ {{ post[5] }}</span>
                    </button>

                    {% if current_user_id == post[3] or is_admin %}
                    <form action="/delete/{{ post[0] }}" method="POST">
                        {% if is_admin %}
                            <button type="submit" class="btn btn-sm btn-danger">å¼·åˆ¶å‰Šé™¤</button>
                        {% else %}
                            <button type="submit" class="btn btn-sm btn-secondary">å‰Šé™¤</button>
                        {% endif %}
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
            ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>å’Œæ–‡ãƒ¢ãƒ¼ãƒ«ã‚¹ã®ä¸–ç•Œã¸ã‚ˆã†ã“ãã€‚
        </div>
        {% endfor %}
    </div>

    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4 mb-5">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link" href="/?page={{ page - 1 }}{% if sort_by %}&sort={{ sort_by }}{% endif %}">å‰ã¸</a>
            </li>
            <li class="page-item disabled">
                <span class="page-link text-dark">{{ page }} / {{ total_pages }}</span>
            </li>
            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="/?page={{ page + 1 }}{% if sort_by %}&sort={{ sort_by }}{% endif %}">æ¬¡ã¸</a>
            </li>
        </ul>
    </nav>
    {% endif %}

</div>

<script>
    const inputArea = document.getElementById('messageInput');
    const helpText = document.getElementById('inputHelp');

    // è¨±å¯ã™ã‚‹æ–‡å­—ä»¥å¤–ã‚’ãƒãƒƒãƒã•ã›ã‚‹æ­£è¦è¡¨ç¾
    // ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€é•·éŸ³ã€æ•°å­—(0-9)ã€ç©ºç™½ã€ã‚¢ãƒ³ã‚«ãƒ¼è¨˜å·(>)ã€å¥èª­ç‚¹
    const invalidPattern = /[^ã-ã‚“ã‚¡-ãƒ¶ãƒ¼0-9\s>ã€ã€‚ï¼ï¼Ÿ]/g;

    function filterInput(e) {
        // IMEå¤‰æ›ä¸­ï¼ˆæ—¥æœ¬èªå…¥åŠ›ã®æœªç¢ºå®šçŠ¶æ…‹ï¼‰ãªã‚‰ä½•ã‚‚ã—ãªã„
        if (e.isComposing) return;

        const originalText = inputArea.value;
        
        // ç¦æ­¢æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰å‰Šé™¤ã™ã‚‹
        if (originalText.match(invalidPattern)) {
            const cleanedText = originalText.replace(invalidPattern, '');
            inputArea.value = cleanedText;

            // è­¦å‘Šã‚’è¡¨ç¤º
            helpText.textContent = "â€»ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ•°å­—ã®ã¿å…¥åŠ›å¯èƒ½ã§ã™";
            
            // 2ç§’å¾Œã«è­¦å‘Šã‚’æ¶ˆã™
            setTimeout(() => { helpText.textContent = ""; }, 2000);
        }
    }

    inputArea.addEventListener('input', filterInput);
    inputArea.addEventListener('compositionend', filterInput);
</script>



</body>
</html>